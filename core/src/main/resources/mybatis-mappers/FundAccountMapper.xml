<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="FundAccountMapper">
    <resultMap id="FundAccount" type="FundAccount">
        <id property="id" column="id"/>
        <result property="ts" column="ts"/>
        <result property="de" column="de"/>

        <result property="info.name" column="name"/>
        <result property="info.icon" column="icon"/>

        <result property="type" column="type"/>
        <result property="fields" column="fields" typeHandler="Json"/>

        <discriminator column="info" javaType="int">
            <case value="1" resultMap="DepositOption"/>
        </discriminator>
    </resultMap>

    <resultMap id="DepositOption" type="DepositOption" autoMapping="false">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="icon" column="icon"/>
    </resultMap>

    <sql id="FundAccountColumns">
        name, type, icon, convert( column_json(fields) using utf8 ) as fields
    </sql>

    <sql id="FundAccountFilter" >
        <where> <if test="filter != null">
            <!-- Entity filter -->
            <if test="filter.id != null"> and id = #{filter.id} </if>
            <if test="filter.de != null"> and de = #{filter.de} </if>

            <!-- FundAccount filter -->
            <if test="filter.name != null"> and name = #{filter.name} </if>
            <if test="filter.type != null"> and type = #{filter.type} </if>
        </if> </where>
    </sql>

    <insert id="create">
        insert into fund_account (
            id,
            name, icon, type,
            fields
        ) values (
            #{id},
            #{info.name}, #{info.icon}, #{type}
            <trim prefix=",">
                <if test="!fields.isEmpty()">
                    <trim prefix="column_create(" suffixOverrides="," suffix=")">
                        <foreach index="field" item="value" collection="fields.entrySet()">
                            #{field}, #{value},
                        </foreach>
                    </trim>
                </if>
            </trim>
        )
    </insert>

    <delete id="delete" >
        <bind name="filter" value="_parameter" />
        delete from fund_account <include refid="FundAccountFilter"/>
    </delete>

    <update id="update">
        update fund_account
        <set>
            <!-- Entity updatable field -->
            <if test="data.de != null"> de = #{data.de}, </if>

            <!-- DepositOption updatable fields -->
            <if test="data.info.name != null"> name = #{data.info.name}, </if>
            <if test="data.info.icon != null"> icon = #{data.info.icon}, </if>

            <!-- FundAccount updatable fields -->
            <if test="data.type != null"> type = #{data.type}, </if>
            <if test="!data.fields.isEmpty()">
                <trim prefix="fields = column_create(" suffixOverrides="," suffix=")">
                    <foreach index="field" item="value" collection="data.fields.entrySet()">
                        #{field}, #{value},
                    </foreach>
                </trim>
            </if>
        </set>
        <include refid="FundAccountFilter"/>
    </update>

    <select id="list" resultMap="FundAccount">
        <bind name="filter" value="_parameter" />
        select
        <include refid="Common.EntityColumns" />,
        <include refid="FundAccountColumns" />,
        #{info} as info
        from fund_account
        <include refid="FundAccountFilter"/>
    </select>
</mapper>